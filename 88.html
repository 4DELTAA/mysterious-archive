<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hidden Archive</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin:0;
  font-family:"Courier New", monospace;
  background:#0f1110;
  color:#d6f5e3;
}
.container {
  max-width:800px;
  margin:0 auto;
  padding:40px 20px;
}
h1 { text-align:center; color:#7fffc1; margin-bottom:40px; }
.section { margin-bottom:40px; padding:20px; border:1px dashed rgba(127,255,193,0.3); background:rgba(15,17,16,0.85);}
h2 { margin-bottom:12px; color:#9affc8; }
button.spoiler {
  display:inline-block;
  margin-bottom:12px;
  padding:6px 12px;
  background:transparent;
  border:1px solid rgba(214,245,227,0.3);
  color:#d6f5e3;
  cursor:pointer;
}
button.spoiler:hover { background: rgba(127,255,193,0.1); }

.video-wrapper {
  position:relative;
  width:100%;
  height:400px;
  margin-bottom:8px;
  border:2px solid rgba(127,255,193,0.3);
  box-shadow:0 0 6px rgba(127,255,193,0.4);
  overflow:hidden;
}
.video-wrapper.reveal {
  animation: flickerOutline 1s ease-in-out;
}
@keyframes flickerOutline {
  0%,100% { box-shadow:0 0 4px rgba(127,255,193,0.3); }
  25% { box-shadow:0 0 12px rgba(127,255,193,0.6); }
  50% { box-shadow:0 0 8px rgba(127,255,193,0.5); }
  75% { box-shadow:0 0 10px rgba(127,255,193,0.55); }
}

/* Spoiler overlay */
.spoiler-overlay {
  position:absolute;
  top:0; left:0; right:0; bottom:0;
  background:#0f1110;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:2;
  transition:opacity 0.2s ease-in-out;
}
.spoiler-overlay.hidden { opacity:0; pointer-events:none; }

/* Loading dots (YouTube style) */
.loading-dots {
  display:flex;
  gap:6px;
}
.loading-dots div {
  width:10px; height:10px; border-radius:50%;
  background:#7fffc1;
  opacity:0.3;
  animation: dotFade 1s infinite;
}
.loading-dots div:nth-child(1){ animation-delay:0s; }
.loading-dots div:nth-child(2){ animation-delay:0.2s; }
.loading-dots div:nth-child(3){ animation-delay:0.4s; }
@keyframes dotFade {
  0%,80%,100% { opacity:0.3; }
  40% { opacity:1; }
}

.download { display:inline-block; margin-top:4px; padding:6px 12px; background:transparent; border:1px solid rgba(214,245,227,0.3); color:#d6f5e3; text-decoration:none; }
.download:hover { background: rgba(127,255,193,0.1); }

.personal-text {
  margin-top:20px;
  min-height:4em;
  white-space:pre-wrap;
  word-break:break-word;
  line-height:1.3em;
}

.section-toggle {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  margin: 12px 0 24px;
  padding: 8px 16px;
  border: 1px solid rgba(214,245,227,0.35);
  background: rgba(8, 14, 10, 0.8);
  color: #d6f5e3;
  cursor: pointer;
}

.section-toggle:hover {
  background: rgba(127,255,193,0.12);
}

.music-section {
  display: none;
}

.music-section.visible {
  display: block;
}

.vote-text {
  margin: 10px 0 16px;
  color: rgba(214,245,227,0.8);
  line-height: 1.4em;
}

.vote-controls {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
  margin-bottom: 18px;
}

.vote-controls input {
  flex: 1 1 220px;
}

.vote-status {
  margin-top: 10px;
  color: #9affc8;
  min-height: 1.4em;
}

.vote-tally {
  margin-top: 16px;
  padding-left: 18px;
  color: rgba(214,245,227,0.9);
}

.music-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 16px;
  margin-top: 16px;
}

.music-card {
  border: 1px solid rgba(127,255,193,0.3);
  padding: 12px;
  background: rgba(10, 12, 11, 0.9);
}

.music-card h3 {
  margin: 0 0 10px;
  color: #9affc8;
  font-size: 1em;
}

.music-card iframe {
  width: 100%;
  height: 160px;
  border: 0;
}

.music-card button {
  margin-top: 10px;
  width: 100%;
  padding: 6px 12px;
  border: 1px solid rgba(214,245,227,0.3);
  background: rgba(15, 17, 16, 0.8);
  color: #d6f5e3;
  cursor: pointer;
}

.music-card button:hover {
  background: rgba(127,255,193,0.12);
}

.glitch-letter { display:inline; animation: glitchChar 0.1s infinite; }
@keyframes glitchChar {
  0% { transform:translate(0,0); color:#d6f5e3; text-shadow:none;}
  25% { transform:translate(-1px,1px); color:#9affc8; text-shadow:1px 0 #ff9a9a;}
  50% { transform:translate(1px,-1px); color:#7fffc1; text-shadow:-1px 0 #ff9a9a,1px 0 #ff9a9a;}
  75% { transform:translate(-1px,0); color:#d6f5e3; text-shadow:1px 0 #ff9a9a,-1px 0 #9affc8;}
  100% { transform:translate(0,0); color:#d6f5e3; text-shadow:none;}
}
</style>
</head>
<body>
<div class="container">
<h1 id="greeting">Hidden Archive</h1>
<div id="personal" class="personal-text"></div>

<button class="section-toggle" type="button" onclick="toggleMusicSection()">
  Enter the Music Vote Chamber
</button>

<div class="section music-section" id="musicVoteSection">
  <h2>Music Video Ballot</h2>
  <p class="vote-text">Add your name, then vote for the music video that should score the new cut. Each name counts once.</p>
  <div class="vote-controls">
    <input id="voteName" placeholder="enter your name or alias">
  </div>
  <div id="voteStatus" class="vote-status"></div>
  <div id="musicVoteList" class="music-grid"></div>
  <ul id="voteTally" class="vote-tally"></ul>
</div>

<!-- Video Sections -->
<div class="section">
  <h2>The Beginning</h2>
  <button class="spoiler" onclick="revealVideo('video1')">Reveal Video</button>
  <div class="video-wrapper" id="video1">
    <div class="spoiler-overlay" id="overlay1">
      <div class="loading-dots"><div></div><div></div><div></div></div>
    </div>
    <iframe width="100%" height="400" src="https://www.youtube.com/embed/Mg0yid5vbRc" frameborder="0" allowfullscreen></iframe>
    <a class="download" href="https://youtu.be/Mg0yid5vbRc" target="_blank">Download "The Beginning"</a>
  </div>
</div>

<div class="section">
  <h2>The Second Coming</h2>
  <button class="spoiler" onclick="revealVideo('video2')">Reveal Video</button>
  <div class="video-wrapper" id="video2">
    <div class="spoiler-overlay" id="overlay2">
      <div class="loading-dots"><div></div><div></div><div></div></div>
    </div>
    <iframe width="100%" height="400" src="https://www.youtube.com/embed/V-EtXn2h3qA" frameborder="0" allowfullscreen></iframe>
    <a class="download" href="https://youtu.be/V-EtXn2h3qA" target="_blank">Download "The Second Coming"</a>
  </div>
</div>

<div class="section">
  <h2>Uncharted Path</h2>
  <button class="spoiler" onclick="revealVideo('video3')">Reveal Video</button>
  <div class="video-wrapper" id="video3">
    <div class="spoiler-overlay" id="overlay3">
      <div class="loading-dots"><div></div><div></div><div></div></div>
    </div>
    <iframe width="100%" height="400" src="https://www.youtube.com/embed/jknp7khNAbk" frameborder="0" allowfullscreen></iframe>
    <a class="download" href="https://youtu.be/jknp7khNAbk" target="_blank">Download "Uncharted Path"</a>
  </div>
</div>

<div class="section">
  <h2>DELT4</h2>
  <button class="spoiler" onclick="revealVideo('video4')">Reveal Video</button>
  <div class="video-wrapper" id="video4">
    <div class="spoiler-overlay" id="overlay4">
      <div class="loading-dots"><div></div><div></div><div></div></div>
    </div>
    <iframe width="100%" height="400" src="https://www.youtube.com/embed/CqmtTeHgO2E" frameborder="0" allowfullscreen></iframe>
    <a class="download" href="https://youtu.be/CqmtTeHgO2E" target="_blank">Download "DELT4"</a>
  </div>
</div>

<div class="section">
  <h2>Last one. For now</h2>
  <button class="spoiler" onclick="revealVideo('video5')">Reveal Video</button>
  <div class="video-wrapper" id="video5">
    <div class="spoiler-overlay" id="overlay5">
      <div class="loading-dots"><div></div><div></div><div></div></div>
    </div>
    <iframe width="100%" height="400" src="https://www.youtube.com/embed/E4ONx3jb0jM" frameborder="0" allowfullscreen></iframe>
    <a class="download" href="https://youtu.be/E4ONx3jb0jM" target="_blank">Download "Last one. For now"</a>
  </div>
</div>

<div class="section">
  <h2>Work in Progress</h2>
  <button class="spoiler" onclick="revealVideo('video6')">Reveal Video</button>
  <div class="video-wrapper" id="video6">
    <div class="spoiler-overlay" id="overlay6">
      <div class="loading-dots"><div></div><div></div><div></div></div>
    </div>
    <div style="width:100%;height:400px;background:#111;color:#ff4a4a;display:flex;align-items:center;justify-content:center;">ERROR 404: Video not found</div>
  </div>
</div>

</div>

<script type="module">
/* ================= FIREBASE (CDN, BROWSER SAFE) ================= */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getFirestore,
  collection,
  doc,
  setDoc,
  onSnapshot,
  serverTimestamp,
  query
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

/* ================= YOUR FIREBASE CONFIG ================= */

const firebaseConfig = {
  apiKey: "AIzaSyBC8G_arzFeVfNsc3JmluXfAR9Q89QnYs4",
  authDomain: "hidden-archive-b1877.firebaseapp.com",
  projectId: "hidden-archive-b1877",
  storageBucket: "hidden-archive-b1877.firebasestorage.app",
  messagingSenderId: "496285101448",
  appId: "1:496285101448:web:9a547ddfffa3b354705e3d",
  measurementId: "G-MHGMMPK198"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= PERSONALIZATION (UNCHANGED) ================= */

const personalMessages = {
  "mimi":["Hey Mimi! You know 88, you got this.","Radium would be proud.","Enjoy the archive <3"],
  "mie":["Hey Mimi! You know 88, you got this.","Radium would be proud.","Enjoy the archive <3"],
  "mieree":["Hey Mimi! You know 88, you got this.","Radium would be proud.","Enjoy the archive <3"],
  "mierees":["Hey Mimi! You know 88, you got this.","Radium would be proud.","Enjoy the archive <3"],
  "saga":["Hello Saga! Check this out carefully.","Your studies helped.","Number 88 again!"],
  "snagz_zz":["Hello Saga! Check this out carefully.","Your studies helped.","Number 88 again!"],
  "aloise":["Aloise! The number 88 welcomes you.","Enjoy your exploration."],
  "aloises":["Aloise! The number 88 welcomes you.","Enjoy your exploration."],
  "snoopy":["Snoopy! Watch out, radium is dangerous.","Stay safe, scientist."],
  "n0op3e":["Snoopy! Watch out, radium is dangerous.","Stay safe, scientist."],
  "isimira":["Snoopy! Watch out, radium is dangerous.","Stay safe, scientist."],
  "leafeon":["Leafy, -4 intelligence? Math is tricky!","Try your best!"],
  "leafy":["Leafy, -4 intelligence? Math is tricky!","Try your best!"],
  "dorian":["Leafy, -4 intelligence? Math is tricky!","Try your best!"],
  "glad":["Glad! Don’t overthink, enjoy."],
  "ggx2":["Glad! Don’t overthink, enjoy."],
  "ares":["Ares! Longtime friend, here’s the archive."],
  "alex":["Ares! Longtime friend, here’s the archive."],
  "xia":["Xia! You’re short but mighty.","Good luck viewing."],
  "xixi":["Xia! You’re short but mighty.","Good luck viewing."],
  "fearless nugget":["Xia! You’re short but mighty.","Good luck viewing."],
  "mona":["Mona! Strawberries are sweet.","Take it easy."],
  "mochi":["Mona! Strawberries are sweet.","Take it easy."]
};

function glitchLetters(text, container, index = 0) {
  if (index >= text.length) return;
  const char = text[index];
  if (char === " ") {
    container.appendChild(document.createTextNode(" "));
  } else {
    const span = document.createElement("span");
    span.className = "glitch-letter";
    span.textContent = char;
    container.appendChild(span);
  }
  setTimeout(() => glitchLetters(text, container, index + 1), 28);
}

function showPersonal() {
  const name = (localStorage.getItem("archive_name") || "").toLowerCase();
  const box = document.getElementById("personal");
  box.innerHTML = "";
  const lines = personalMessages[name] || ["Welcome, guest.","Enjoy the hidden archive."];
  let delay = 0;
  lines.forEach(line => {
    setTimeout(() => {
      glitchLetters(line, box);
      box.appendChild(document.createElement("br"));
    }, delay);
    delay += line.length * 35 + 160;
  });
  document.getElementById("greeting").innerText = "Welcome to the Archive!";
}

/* ================= VIDEO SPOILERS ================= */

window.revealVideo = function(id) {
  const wrapper = document.getElementById(id);
  const overlay = wrapper.querySelector(".spoiler-overlay");
  if (!overlay || overlay.classList.contains("hidden")) return;
  wrapper.classList.add("reveal");
  setTimeout(() => overlay.classList.add("hidden"), 700);
};

/* ================= MUSIC VOTING (FIRESTORE, SHARED) ================= */

const musicVideos = [
  { title: "Coconut Mall", id: "mrAG3bZ0NGA", url: "https://www.youtube.com/watch?v=mrAG3bZ0NGA" },
  { title: "Bad Apple", id: "FtutLA63Cp8", url: "https://www.youtube.com/watch?v=FtutLA63Cp8" },
  { title: "Powerpuff Girls", id: "GZqi2Nv2M04", url: "https://www.youtube.com/watch?v=GZqi2Nv2M04" },
  { title: "Romance Sengen", id: "w3RDwQjUekU", url: "https://www.youtube.com/watch?v=w3RDwQjUekU" },
  { title: "IRIS OUT", id: "ux3QETpLcPs", url: "https://www.youtube.com/watch?v=ux3QETpLcPs" },
  { title: "It's been so RAAAH", id: "EHpUtZ7yiYc", url: "https://www.youtube.com/watch?v=EHpUtZ7yiYc" },
  { title: "Papyrus", id: "FezNgPThD3M", url: "https://www.youtube.com/watch?v=FezNgPThD3M" },
  { title: "Chess Type Beat", id: "EK2w6qA5zz8", url: "https://www.youtube.com/watch?v=EK2w6qA5zz8" }
];

const votesCol = collection(db, "musicVotes");
let liveVotes = {};

function renderVoteTally() {
  const tally = {};
  musicVideos.forEach(v => tally[v.id] = 0);

  Object.values(liveVotes).forEach(vote => {
    if (tally[vote.choiceId] !== undefined) {
      tally[vote.choiceId]++;
    }
  });

  const ul = document.getElementById("voteTally");
  ul.innerHTML = "";
  musicVideos.forEach(v => {
    const li = document.createElement("li");
    li.textContent = `${v.title}: ${tally[v.id]} vote${tally[v.id] === 1 ? "" : "s"}`;
    ul.appendChild(li);
  });
}

function startVoteListener() {
  onSnapshot(query(votesCol), snap => {
    const next = {};
    snap.forEach(d => next[d.id] = d.data());
    liveVotes = next;
    renderVoteTally();
  });
}

function castVote(video) {
  const nameInput = document.getElementById("voteName");
  const status = document.getElementById("voteStatus");
  const raw = nameInput.value.trim();
  const id = raw.toLowerCase();
  if (!id) {
    status.textContent = "A name is required to vote.";
    status.style.color = "#ff9a9a";
    return;
  }
  setDoc(doc(db, "musicVotes", id), {
    displayName: raw,
    choiceId: video.id,
    choiceTitle: video.title,
    updatedAt: serverTimestamp()
  }, { merge: true });
  status.textContent = `Vote recorded for "${video.title}".`;
  status.style.color = "#9affc8";
}

function renderMusicOptions() {
  const list = document.getElementById("musicVoteList");
  list.innerHTML = "";
  musicVideos.forEach(video => {
    const card = document.createElement("div");
    card.className = "music-card";
    card.innerHTML = `
      <h3>${video.title}</h3>
      <iframe src="https://www.youtube.com/embed/${video.id}" allowfullscreen></iframe>
      <a class="download" href="${video.url}" target="_blank">Open on YouTube</a>
    `;
    const btn = document.createElement("button");
    btn.textContent = "Vote for this video";
    btn.onclick = () => castVote(video);
    card.appendChild(btn);
    list.appendChild(card);
  });
}

window.toggleMusicSection = function() {
  const section = document.getElementById("musicVoteSection");
  section.classList.toggle("visible");
};

/* ================= INIT ================= */

window.onload = () => {
  showPersonal();
  renderMusicOptions();
  startVoteListener();
};
</script>
</body>
</html>
